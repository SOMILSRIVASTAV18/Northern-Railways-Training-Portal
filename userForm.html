<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>User Information Form</title>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        min-height: 100vh;
        margin: 0;
        padding: 40px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .main-container { max-width: 1000px; width: 100%; margin: 0 auto; }
      .card { border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border: none; overflow: hidden; background-color: white; }
      .card-header { background-color: #0056b3; color: white; text-align: center; padding: 25px; border-bottom: none; }
      .logo { max-width: 80px; margin-bottom: 15px; }
      h1 { font-weight: 600; font-size: 28px; margin-bottom: 0; }
      .card-body { padding: 30px; }
      .form-label { font-weight: 500; color: #495057; margin-bottom: 8px; }
      .form-control { border-radius: 8px; padding: 12px 15px; border: 1px solid #ced4da; margin-bottom: 5px; }
      .form-control:focus { box-shadow: 0 0 0 0.25rem rgba(0, 86, 179, 0.25); border-color: #0056b3; }
      .btn-primary { background-color: #0056b3; border-color: #0056b3; padding: 12px 30px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; }
      .btn-primary:hover { background-color: #003d82; border-color: #003d82; transform: translateY(-2px); }
      .btn-outline-danger { border-radius: 8px; padding: 10px 25px; font-weight: 500; transition: all 0.3s ease; }
      .btn-outline-danger:hover { transform: translateY(-2px); }
      .alert { border-radius: 8px; padding: 15px; }
      .form-text { color: #6c757d; font-size: 0.85rem; margin-top: 5px; }
      .progress-indicator { display: flex; justify-content: center; margin-bottom: 30px; }
      .progress-step { display: flex; flex-direction: column; align-items: center; width: 120px; }
      .step-circle { width: 35px; height: 35px; border-radius: 50%; background-color: #e9ecef; color: #6c757d; display: flex; justify-content: center; align-items: center; font-weight: 600; margin-bottom: 8px; }
      .step-circle.active { background-color: #0056b3; color: white; }
      .step-line { height: 3px; width: 100px; background-color: #e9ecef; margin: 0 -10px; margin-top: 17px; }
      .step-line.active { background-color: #0056b3; }
      .step-text { font-size: 0.85rem; color: #6c757d; text-align: center; }
      .step-text.active { color: #0056b3; font-weight: 600; }
    </style>
  </head>
  <body>
    <div class="card">
        <div class="card-header">
          <img src="https://upload.wikimedia.org/wikipedia/en/thumb/8/83/Indian_Railways.svg/1200px-Indian_Railways.svg.png" alt="Northern Railways Logo" class="logo">
          <h1>Northern Railways Training Portal</h1>
          <p class="text-light mb-0">Complete your registration by providing the required information</p>
        </div>

        <div class="card-body">
          <div class="progress-indicator">
            <div class="progress-step"><div class="step-circle active">1</div><div class="step-text active">Registration</div></div>
            <div class="step-line active"></div>
            <div class="progress-step"><div class="step-circle active">2</div><div class="step-text active">User Information</div></div>
            <div class="step-line"></div>
            <div class="progress-step"><div class="step-circle">3</div><div class="step-text">Payment</div></div>
            <div class="step-line"></div>
            <div class="progress-step"><div class="step-circle">4</div><div class="step-text">Confirmation</div></div>
          </div>

          <h1 class="text-center mb-4">User Information Form</h1>

          <form id="userInfoForm" onsubmit="submitUserInfo(); return false;">
            <div class="mb-3"><label for="fullName" class="form-label">Full Name</label><input type="text" class="form-control" id="fullName" name="fullName" required></div>
            <div class="mb-3"><label for="guardian" class="form-label">Parent/Guardian Name</label><input type="text" class="form-control" id="guardian" name="guardian" required></div>
            <div class="mb-3"><label for="dob" class="form-label">Date of Birth</label><input type="date" class="form-control" id="dob" name="dob" required></div>
            <div class="mb-3"><label for="gender" class="form-label">Gender</label><select class="form-control" id="gender" name="gender" required><option value="">Select your Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
            <div class="mb-3"><label for="phoneNumber" class="form-label">Phone Number</label><input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" required></div>
            <div class="mb-3"><label for="address" class="form-label">Address</label><textarea class="form-control" id="address" name="address" rows="3" required></textarea></div>
            <div class="mb-3"><label for="college" class="form-label">College</label><input type="text" class="form-control" id="college" name="college" required></div>
            <div class="mb-3"><label for="currentYear" class="form-label">Current Academic Year</label><input type="number" class="form-control" id="currentYear" name="currentYear" min="1" max="5" placeholder="e.g., 3" required></div>
            <div class="mb-3"><label for="userPhoto" class="form-label">Your Photo</label><input type="file" class="form-control" id="userPhoto" name="userPhoto" accept="image/jpeg, image/png" required><div class="form-text">Please upload a passport-sized photo (JPEG or PNG, max 5MB).</div></div>

            <hr class="my-4">
            <h4 class="mb-3">Training Details</h4>

            <div class="mb-3">
              <label for="trainingDuration" class="form-label">1. Select Duration of Your Training</label>
              <select class="form-control" id="trainingDuration" name="trainingDuration" required>
                <option value="">Select Duration</option>
                <option value="4 Weeks">4 Weeks</option>
                <option value="6 Weeks">6 Weeks</option>
                <option value="8 Weeks">8 Weeks</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="course" class="form-label">2. Select Your Course</label>
              <select class="form-control" id="course" name="course" required>
                <option value="">Select your Course</option>
                <option value="B.Tech">B.Tech</option>
                <option value="Polytechnic">Polytechnic</option>
                <option value="Other">Other Technical/Vocational Training</option>
              </select>
            </div>

            <div class="mb-3" id="otherCourseDiv" style="display:none;">
              <label for="otherCourse" class="form-label">Please Specify Your Course Name</label>
              <input type="text" class="form-control" id="otherCourse" name="otherCourse">
            </div>

            <div class="mb-3" id="branchDiv" style="display:none;">
              <label for="branch" class="form-label">3. Select Your Branch</label>
              <select class="form-control" id="branch" name="branch">
                <option value="">Select your Branch</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Electronic and Communication">Electronic and Communication</option>
                <option value="Electrical">Electrical</option>
                <option value="Mechanical">Mechanical</option>
                <option value="Civil">Civil</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="mb-3" id="otherBranchDiv" style="display:none;">
              <label for="otherBranch" class="form-label">Please Specify Your Branch Name</label>
              <input type="text" class="form-control" id="otherBranch" name="otherBranch">
            </div>

            <div class="mb-3">
                <label for="startDateOfBatch" class="form-label">4. Select Start Date of Batch</label>
                <select class="form-control" id="startDateOfBatch" name="startDateOfBatch" required>
                    <option value="">Loading available dates...</option>
                </select>
            </div>

            <div class="mb-3" id="projectDiv" style="display:none;">
              <label for="project" class="form-label">5. Select Your Preferred Project</label>
              <select class="form-control" id="project" name="project">
                <option value="">Select a Project</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">Submit Information</button>
          </form>

          <div id="message" class="alert mt-3" style="display: none;"></div>

          <div class="text-center mt-4">
            <button onclick="logoutUser()" class="btn btn-outline-danger">Logout</button>
          </div>
        </div>
    </div>

    <script>
      const MAX_STUDENTS_PER_PROJECT_BATCH_CLIENT = 15; // Must match backend constant

      // --- NEW DATA STRUCTURE ---
      // Projects are now categorized by DURATION and then by BRANCH.
      const projectsByDurationAndBranch = {
        "4 Weeks": {
          "Computer Science": ["Web Application for Ticket Booking (4w)", "Railway Employee Portal (4w)", "Data Analysis of Train Delays (4w)"],
          "Electronic and Communication": ["IoT for Track Monitoring (4w)", "Passenger Announcement System Design (4w)"],
          "Electrical": ["Study of OHE Maintenance (4w)", "Energy Audit of a Railway Station (4w)"],
          "Mechanical": ["Analysis of Wagon Braking Systems (4w)", "CAD Modeling of Coach Components (4w)"],
          "Civil": ["Survey and Analysis of a Railway Line (4w)", "Station Layout and Design Study (4w)"],
          "Other": ["Railway Safety Procedures Audit (4w)"], // This "Other" is for generic courses
          "General": ["Railway Operations Overview (4w)", "Passenger Service Quality Study (4w)", "Safety Protocol Documentation (4w)"]
        },
        "6 Weeks": {
          "Computer Science": ["Machine Learning for Predictive Maintenance (6w)", "Mobile App for Live Train Tracking (6w)", "Cybersecurity for Railway Networks (6w)"],
          "Electronic and Communication": ["Implementation of a Signal Control System (6w)", "Wireless Communication in Tunnels (6w)"],
          "Electrical": ["Traction Motor Control System Study (6w)", "SCADA System for Power Supply (6w)"],
          "Mechanical": ["Vibration Analysis in Locomotives (6w)", "Improving Coach Suspension Systems (6w)"],
          "Civil": ["Bridge Inspection and Maintenance Project (6w)", "Geotechnical Study for Track Stability (6w)"],
          "Other": ["Logistics and Supply Chain Management (6w)"], // This "Other" is for generic courses
          "General": ["Logistics and Supply Chain Analysis (6w)", "Environmental Impact Assessment (6w)", "Customer Relationship Management in Railways (6w)"]
        },
        "8 Weeks": {
          "Computer Science": ["Advanced Railway Management System (8w)", "AI-Powered Route Optimization (8w)"],
          "Electronic and Communication": ["Advanced Railway Signaling Project (8w)", "Automated Vehicle Identification System (8w)"],
          "Electrical": ["Regenerative Braking System Analysis (8w)", "Smart Grid for Railway Power (8w)"],
          "Mechanical": ["Comprehensive Locomotive Maintenance Project (8w)", "Failure Analysis of Mechanical Components (8w)"],
          "Civil": ["High-Speed Rail Corridor Planning (8w)", "Modern Tunneling Techniques Study (8w)"],
          "Other": ["Full-Scale Operations Management Project (8w)"], // This "Other" is for generic courses
          "General": ["Comprehensive Station Management Project (8w)", "Ticketing System Improvement Proposal (8w)", "Disaster Management Planning for Railways (8w)"]
        }
      };

      let availableBatchData = { futureMondays: [], projectCounts: {} }; // Stores data from backend

      // --- NEW CENTRALIZED FUNCTION to manage form visibility and options ---
      function updateFormVisibility() {
        const durationSelect = document.getElementById('trainingDuration');
        const courseSelect = document.getElementById('course');
        const otherCourseDiv = document.getElementById('otherCourseDiv');
        const otherCourseInput = document.getElementById('otherCourse');
        const branchDiv = document.getElementById('branchDiv');
        const branchSelect = document.getElementById('branch');
        const otherBranchDiv = document.getElementById('otherBranchDiv'); // NEW
        const otherBranchInput = document.getElementById('otherBranch');   // NEW
        const projectDiv = document.getElementById('projectDiv');
        const projectSelect = document.getElementById('project');
        const startDateOfBatchSelect = document.getElementById('startDateOfBatch');

        const selectedDuration = durationSelect.value;
        const selectedCourse = courseSelect.value;
        const selectedBranch = branchSelect.value;
        const selectedStartDateFormatted = startDateOfBatchSelect.value; // YYYYMMDD format

        // Helper to hide and reset a form field
        const hideAndReset = (div, input) => {
          div.style.display = 'none';
          input.required = false;
          if (input.tagName === 'SELECT') {
            input.value = '';
          } else if (input.type === 'text') {
            input.value = '';
          }
        };

        // 1. Handle "Other Course" text input
        if (selectedCourse === 'Other') {
          otherCourseDiv.style.display = 'block';
          otherCourseInput.required = true;
        } else {
          hideAndReset(otherCourseDiv, otherCourseInput);
        }

        // 2. Handle "Branch" dropdown visibility
        if (selectedCourse === 'B.Tech' || selectedCourse === 'Polytechnic') {
          branchDiv.style.display = 'block';
          branchSelect.required = true;
        } else {
          hideAndReset(branchDiv, branchSelect);
          hideAndReset(otherBranchDiv, otherBranchInput); // Also hide "Other Branch" if branch is not shown
        }

        // 3. Handle "Other Branch" text input (NEW)
        if (selectedBranch === 'Other' && (selectedCourse === 'B.Tech' || selectedCourse === 'Polytechnic')) {
          otherBranchDiv.style.display = 'block';
          otherBranchInput.required = true;
        } else {
          hideAndReset(otherBranchDiv, otherBranchInput);
        }

        // 4. Populate or hide the "Project" dropdown
        let projects = [];
        const projectsForDuration = projectsByDurationAndBranch[selectedDuration];

        if (projectsForDuration) {
          if (branchDiv.style.display === 'block' && selectedBranch && selectedBranch !== 'Other') {
            // If a specific branch is selected (and not 'Other')
            projects = projectsForDuration[selectedBranch] || [];
          } else if (selectedCourse === 'Other' || selectedBranch === 'Other') {
            // If the course is "Other" or the branch is "Other", use "General" projects
            projects = projectsForDuration['General'] || [];
          }
        }

        projectSelect.innerHTML = '<option value="">Select a Project</option>'; // Clear previous options
        if (projects.length > 0) {
          projectDiv.style.display = 'block';
          projectSelect.required = true;

          const currentBatchProjectCounts = availableBatchData.projectCounts[selectedStartDateFormatted] ?
                                            availableBatchData.projectCounts[selectedStartDateFormatted].projects : {};

          projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;

            const count = currentBatchProjectCounts[project] || 0;
            if (count >= MAX_STUDENTS_PER_PROJECT_BATCH_CLIENT) {
              option.disabled = true;
              option.textContent += ` (Full - ${count}/${MAX_STUDENTS_PER_PROJECT_BATCH_CLIENT})`;
            } else {
              option.textContent += ` (${count}/${MAX_STUDENTS_PER_PROJECT_BATCH_CLIENT} filled)`;
            }
            projectSelect.appendChild(option);
          });
        } else {
          hideAndReset(projectDiv, projectSelect);
        }
      }

      // --- MODIFIED FUNCTION to manually populate batch start dates ---
      function populateBatchAndProjectOptions() {
        const startDateOfBatchSelect = document.getElementById('startDateOfBatch');
        startDateOfBatchSelect.innerHTML = '<option value="">Select a Batch Start Date</option>'; // Reset

        // Manually define your future Monday dates here (example dates are in 2025)
        const manualFutureMondays = [
          { dateString: "2025-07-21" }, 
          { dateString: "2025-07-28" }, 
          { dateString: "2025-08-04" }  
        ];

        // Populate the availableBatchData with your manual dates
        availableBatchData.futureMondays = manualFutureMondays;
        

        if (availableBatchData.futureMondays.length > 0) {
          availableBatchData.futureMondays.forEach(monday => {
            const option = document.createElement('option');
            option.value = monday.dateString;
            option.textContent = monday.dateString;
            startDateOfBatchSelect.appendChild(option);
          });
        } else {
          startDateOfBatchSelect.innerHTML = '<option value="">No future batch dates available</option>';
        }
        updateFormVisibility(); // Update project options after dates are loaded
      }


      // --- INITIALIZE FORM AND ADD EVENT LISTENERS ---
      document.addEventListener('DOMContentLoaded', function() {
        populateBatchAndProjectOptions(); // Fetch and populate batch dates on load

        // Add event listeners to trigger updates
        document.getElementById('trainingDuration').addEventListener('change', updateFormVisibility);
        document.getElementById('course').addEventListener('change', updateFormVisibility);
        document.getElementById('branch').addEventListener('change', updateFormVisibility); // This is crucial for 'Other' branch
        document.getElementById('startDateOfBatch').addEventListener('change', updateFormVisibility); // New listener
      });

      // --- UPDATED SUBMISSION FUNCTION ---
      function submitUserInfo() {
        const form = document.getElementById('userInfoForm');
        const fileInput = document.getElementById('userPhoto');

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        if (fileInput.files.length === 0) {
          showMessage('Please select a photo to upload.', true);
          return;
        }

        const file = fileInput.files[0];
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          showMessage('File size exceeds 5MB. Please upload a smaller image.', true);
          return;
        }

        showMessage('Submitting your information, please wait...', false);
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        const reader = new FileReader();
        reader.onload = function(e) {
          const fileData = e.target.result.split(',')[1];

          // Handle the course name: use the 'other' field if it was selected
          const courseValue = form.course.value === 'Other' ? form.otherCourse.value : form.course.value;
          // Handle the branch name: use the 'other' field if it was selected (NEW)
          const branchValue = form.branch.value === 'Other' ? form.otherBranch.value : form.branch.value;


          const formData = {
            fullName: form.fullName.value,
            phoneNumber: form.phoneNumber.value,
            college: form.college.value,
            address: form.address.value,
            photoData: fileData,
            photoName: file.name,
            photoType: file.type,
            dateOfBirth: form.dob.value,
            gender: form.gender.value,
            course: courseValue, // Use the potentially modified course name
            branch: branchValue || "", // Use the potentially modified branch name (NEW)
            guardianName: form.guardian.value,
            trainingDuration: form.trainingDuration.value,
            project: form.project.value || "",
            currentYear: form.currentYear.value,
            startDateOfBatch: form.startDateOfBatch.value // NEW: Pass selected start date
          };

          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showMessage('Information submitted successfully! Your unique ID is: ' + result.uniqueId + '. You are assigned to Batch: ' + result.batchCode + ' starting on ' + result.startDateOfBatch + '. Redirecting to the payment page...', false);
                form.reset();
                setTimeout(() => { window.location.href = '?page=paymentVerification'; }, 7000); // Increased delay to read message
              } else {
                showMessage('Submission failed: ' + result.message, true);
                submitButton.disabled = false;
              }
            })
            .withFailureHandler(function(error) {
              showMessage('Error: ' + (error.message || 'An unknown error occurred. Please try again.'), true);
              submitButton.disabled = false;
              console.error('Form submission error:', error);
            })
            .processUserInfo(formData);
        };
        reader.readAsDataURL(file);
      }

      function showMessage(text, isError = false) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = isError ? 'alert alert-danger mt-3' : 'alert alert-success mt-3';
        messageDiv.style.display = 'block';
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function logoutUser() {
        showMessage('Logging out...', false);
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              window.location.href = '?';
            } else {
              showMessage('Logout failed: ' + (result.message || 'Unknown error'), true);
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Logout error: ' + (error.message || 'Unknown error occurred'), true);
          })
          .logout();
      }
    </script>
  </body>
</html>