<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>Admin Report Generator</title>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        min-height: 100vh;
        margin: 0;
        padding: 40px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .card { border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border: none; overflow: hidden; background-color: white; max-width: 700px; width: 100%; }
      .card-header { background-color: #0056b3; color: white; text-align: center; padding: 25px; border-bottom: none; }
      .logo { max-width: 80px; margin-bottom: 15px; }
      h1 { font-weight: 600; font-size: 28px; margin-bottom: 0; }
      .card-body { padding: 30px; }
      .form-label { font-weight: 500; color: #495057; margin-bottom: 8px; }
      .form-control { border-radius: 8px; padding: 12px 15px; border: 1px solid #ced4da; margin-bottom: 5px; }
      .form-control:focus { box-shadow: 0 0 0 0.25rem rgba(0, 86, 179, 0.25); border-color: #0056b3; }
      .btn-primary { background-color: #0056b3; border-color: #0056b3; padding: 12px 30px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; }
      .btn-primary:hover { background-color: #003d82; border-color: #003d82; transform: translateY(-2px); }
      .btn-outline-danger { border-radius: 8px; padding: 10px 25px; font-weight: 500; transition: all 0.3s ease; }
      .btn-outline-danger:hover { transform: translateY(-2px); }
      .alert { border-radius: 8px; padding: 15px; }
      .loading-spinner { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid #0056b3; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div class="card">
        <div class="card-header">
          <img src="https://upload.wikimedia.org/wikipedia/en/thumb/8/83/Indian_Railways.svg/1200px-Indian_Railways.svg.png" alt="Northern Railways Logo" class="logo">
          <h1>Admin Report Generator</h1>
          <p class="text-light mb-0">Generate PDF reports for specific batches and projects</p>
        </div>

        <div class="card-body">
          <form id="reportForm" onsubmit="generatePdfReport(); return false;">
            <div class="mb-3">
              <label for="batchCode" class="form-label">Select Batch Code</label>
              <select class="form-control" id="batchCode" required>
                <option value="">Loading batches...</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="projectName" class="form-label">Select Project Name</label>
              <select class="form-control" id="projectName" required>
                <option value="">Select a batch first...</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3" id="downloadBtn">
              <i class="fas fa-download me-2"></i> Download PDF Report
            </button>
          </form>

          <div class="loading-spinner" id="loadingSpinner"></div>
          <div id="message" class="alert mt-3" style="display: none;"></div>

          <div class="text-center mt-4">
            <button onclick="logoutUser()" class="btn btn-outline-danger">Logout</button>
          </div>
        </div>
    </div>

    <script>
      let allBatchProjectData = []; // Stores all unique batch-project combinations

      document.addEventListener('DOMContentLoaded', function() {
        loadBatchAndProjectOptions();

        document.getElementById('batchCode').addEventListener('change', filterProjectsByBatch);
      });

      function showMessage(text, isError = false) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = isError ? 'alert alert-danger mt-3' : 'alert alert-success mt-3';
        messageDiv.style.display = 'block';
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        const button = document.getElementById('downloadBtn');
        if (show) {
          spinner.style.display = 'block';
          button.disabled = true;
          showMessage('Generating PDF, please wait...', false);
        } else {
          spinner.style.display = 'none';
          button.disabled = false;
        }
      }

      function loadBatchAndProjectOptions() {
        showLoading(true);
        showMessage('Loading batch and project data...', false);

        google.script.run
          .withSuccessHandler(function(data) {
            showLoading(false);
            if (data.success) {
              allBatchProjectData = data.combinations;
              populateBatchDropdown(data.uniqueBatchCodes);
              showMessage('Data loaded. Select a batch and project.', false);
            } else {
              showMessage('Failed to load data: ' + data.message, true);
            }
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showMessage('Error loading data: ' + (error.message || 'Unknown error'), true);
            console.error('Error fetching batch/project options:', error);
          })
          .getBatchAndProjectOptionsForAdmin();
      }

      function populateBatchDropdown(batchCodes) {
        const batchSelect = document.getElementById('batchCode');
        batchSelect.innerHTML = '<option value="">-- Select Batch Code --</option>';
        batchCodes.forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          batchSelect.appendChild(option);
        });
        filterProjectsByBatch(); // Initialize project dropdown
      }

      function filterProjectsByBatch() {
        const batchSelect = document.getElementById('batchCode');
        const projectSelect = document.getElementById('projectName');
        const selectedBatch = batchSelect.value;

        projectSelect.innerHTML = '<option value="">-- Select Project Name --</option>';
        projectSelect.disabled = true;

        if (selectedBatch) {
          const projectsForSelectedBatch = allBatchProjectData
            .filter(item => item.batchCode === selectedBatch)
            .map(item => item.projectName);

          // Get unique project names for the selected batch
          const uniqueProjects = [...new Set(projectsForSelectedBatch)];

          uniqueProjects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            projectSelect.appendChild(option);
          });
          projectSelect.disabled = false;
        }
      }

      function generatePdfReport() {
        const batchCode = document.getElementById('batchCode').value;
        const projectName = document.getElementById('projectName').value;

        if (!batchCode || !projectName) {
          showMessage('Please select both a Batch Code and a Project Name.', true);
          return;
        }

        showLoading(true);
        showMessage('Generating PDF report for ' + projectName + ' in ' + batchCode + '...', false);

        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            if (result.success && result.url) {
              showMessage('PDF report generated successfully! Opening in new tab.', false);
              window.open(result.url, '_blank');
            } else {
              showMessage('Failed to generate PDF: ' + (result.message || 'Unknown error.'), true);
            }
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showMessage('Error generating PDF: ' + (error.message || 'An unknown error occurred.'), true);
            console.error('PDF generation error:', error);
          })
          .generateAndGetBatchProjectPdfUrl(batchCode, projectName);
      }

      function logoutUser() {
        showMessage('Logging out...', false);
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              window.location.href = '?';
            } else {
              showMessage('Logout failed: ' + (result.message || 'Unknown error'), true);
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Logout error: ' + (error.message || 'Unknown error occurred'), true);
          })
          .logout();
      }
    </script>
  </body>
</html